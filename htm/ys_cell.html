<!DOCTYPE html>
<html>
<head>
	<title>印順導師著作聞思</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" type="text/css" href="../css/common.css" />
	<link rel="stylesheet" type="text/css" href="../css/menutree.css" />

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	<script src="../data/pnjjj_book.js"></script>
	<script src="../data/ffgl_kr_2014.js"></script>
	<script src="../data/ffgl_kr_2014_aux.js"></script>
	<script src="../data/fzrj_kr_2015.js"></script>
	<script src="../data/auxData_0001.js"></script>
	<script src="../data/auxData_0002.js"></script>
	<script src="../data/pnj_style.js"></script>
	<script src="../data/pnj_book.js"></script>
	<script src="../data/ffgl_book.js"></script>
	
	<script src="../data/base_List.js"></script>
	<script src="../data/lecture_List.js"></script>
	<script src="../data/lesson_List.js"></script>
	<script src="../data/cuePoint_List.js"></script>
	
	<script src="../js/kEssayNode.js"></script>
	<script src="../js/ui.js"></script>
	<script src="../js/search.js"></script>
	<script src="../js/mysBooks.js"></script>
	<script src="../js/kEssay.js"></script>
	
	<script>
var mbIsPC = false;
//var msSourceWords = "srcwords mobilSWcolor"; //引文字體、色，供 toHtml 參用於行動裝置
//var msNoteareaBg = "div.notearea div.notearea_m"; //註解區背景色

var theBook = null;
var theAud = null;

var onLoad = function() {
//var sQry = decodeURIComponent(location.search).slice(1);
//var q = JSON.parse("{" + sQry + "}");

	var q = JSON.parse(decodeURIComponent(location.search).substr(6));

	mbIsPC = !uaNotPC();

	document.getElementById("tit_booklecName").innerHTML = q.bkName + "：" + q.lecName;

	theAud = new mysAud();
	theBook = new mysBooks(q.bkId, q.lecId);
	fitDevice();
	theBook.fillBook();
	
	if (mbIsPC) {
		if (window.addEventListener) {              
		    window.addEventListener("resize", rstPosition);
//		    window.addEventListener("onclick", winOnClick);
		} else if (window.attachEvent) {                 
		    window.attachEvent("onresize", rstPosition);
//		    window.attachEvent("onclick", winOnClick);
		}
	}
	
	rstPosition();
}



//讀取書本的各「章」名稱，作為選單
var grabEssayChapter=function(jsEsy) {
	var aChapt = [];
	for (s in jsEsy) {
		aChapt.push(s);
	}
	
	return aChapt;
}

//將指定的「章」，填入展示的 divRoot
//var openEssay=function(divRoot, jsnChapter, selPageList) {
var openEssay=function(bCM, jsnChapter) {
	var divRoot = (bCM ? theBook.ctlShowYin : theBook.ctlShowAux);
	var mnu = (bCM ? theBook.mnuCm : theBook.mnuAux);
	var selPageList = (bCM ? theBook.selPageListYin : theBook.selPageListAux);
	var idTail = (bCM ? "" : "_H");

	divRoot.innerHTML = "";
	
	while (selPageList.length > 0) selPageList.remove(0);
	
	var esy = new kEssayNode(divRoot, jsnChapter, selPageList, idTail);
	esy.transData();
	createCmMenu(esy.maToc, mnu);
	
	doToggleBR(divRoot);
}



function createCmMenu(aTocItem, mnu) {
	var sPath = hostImgURL();
	var rtUL = mnu; //document.getElementById("mnuRoot");
	
	while (rtUL.childNodes.length > 0){
		rtUL.removeChild(rtUL.childNodes[0]);
	}

	var ndUL;
	
	for (var i=0; i < aTocItem.length; i++) {
	    var textnode = document.createTextNode(aTocItem[i].c);
	    var ndAnchor = document.createElement("A");
//	    var ndSpan = document.createElement("SPAN");
	    var nd = document.createElement("LI");
		var nOffset = -1;

	    ndAnchor.appendChild(textnode);
	    ndAnchor.setAttribute("href", "#" + aTocItem[i].a);
//	    ndSpan.appendChild(textnode);

		if (aTocItem[i].lev == 0) {
    		ndUL = rtUL;
			nOffset = -1;
		}
		else
			nOffset = (aTocItem[i-1].lev - aTocItem[i].lev);
		
		if (nOffset < -1) {
			alert("Toc.level 錯誤；請檢視 console.log。");
			console.log("Err of Toc.level: prev= ",aTocItem[i-1].lev,", curr= ", aTocItem[i].lev);
		}
			
    	if (i==aTocItem.length-1 || aTocItem[i+1].lev <= aTocItem[i].lev) {
	    	nd.style.listStyleImage = 'none';
    	} else
	    	nd.style.listStyleImage = 'url("' + sPath + 'open_brk.png")';

	    nd.appendChild(ndAnchor);
//	    nd.appendChild(ndSpan);
		
		if (nOffset == 0) {
			ndUL.appendChild(nd);

			if (i<aTocItem.length-1 && aTocItem[i+1].lev > aTocItem[i].lev) {
	    		ndUL = document.createElement("UL");
				nd.appendChild(ndUL);
			}
		} else if (nOffset < 0){
			ndUL.appendChild(nd);
			if (i<aTocItem.length-1 && aTocItem[i+1].lev > aTocItem[i].lev) {
	    		ndUL = document.createElement("UL");
				nd.appendChild(ndUL);
			}
		} else {
			for (j=0; j<nOffset; j++) {
				ndUL = ndUL.parentNode.parentNode;
			}
				
			ndUL.appendChild(nd);
			
			if (i<aTocItem.length-1 && aTocItem[i+1].lev > aTocItem[i].lev) {
	    		ndUL = document.createElement("UL");
				nd.appendChild(ndUL);
			}
		}
	}
}



function onMenuClicked(ev) {
	var sPath = hostImgURL();

	var eTrigger = ev.target;
//	document.getElementById("demo").innerHTML = eTrigger.nodeName

	if (eTrigger.nodeName == "A") {
		theBook.mbJumpAnchor = true;
		//skip to html#id
	}
	
		//eTrigger.children.length > 1 沒有子 ul 者，只有 textnode/span 1 個 
	if (eTrigger.nodeName == "LI" && eTrigger.children.length>1) {
		var url = eTrigger.style.listStyleImage;
		var bOpened = url.includes("open");
		var disp = (bOpened ? "none" : "block");
		
		eTrigger.style.listStyleImage = 'url("' + sPath + (bOpened ? "close_brk.png" : "open_brk.png") + '")';

		for (var i=0; i<eTrigger.children.length; i++) {
			if (eTrigger.children[i].nodeName == "UL") {
				eTrigger.children[i].style.display = disp;
				break;
			}
		}
	}
}
	</script>
</head>

<body onload="onLoad()">
<div  class="audioGroup">
<span id="tit_booklecName" style="font-size:90%;font-family:標楷體;font-weight:bold;"></span><br/>
<!--<span id="try" style="width:80%;"></span>-->
</div>

<!--期別、著文、講義切換-->
<table class="audioGroup" id="tblShowPhrase" style="visibility:visible;background-color:lightGray;margin-top:3px;"><tr>
	<td id="tdPhrase">
<button id="toggleHandout" onclick="toggleHandout(this)" class="toggle">期別</button>
	</td>
	<td><a style="padding:2px;" id="goSite" href="" target="_blank">到網頁</a></td>
	<td>
	<span id="dvPhase"><select><option>第 1 期 104 年</option><select><span>
	</td>
	<td id="dvLesson" style="vertical-align: middle;">
		<select><option>104 年</option><select>
	</td>
	
<td style="position:relative;">
	<button id="btnDropdnProcess" onclick="tglDropDown(this,2)" class="dropbtn">進度</button>
	  <div id="dropdnProcess" class="dropdown-content" style="width:16em;right:0;height:26em;"> </div></td>
	
<!--	<td><button onclick="theAud.showCue()" style="margin-left:6px;display:none">cue</button></td>-->
</tr></table>

<!--講義-->
	<table class="audioGroup" id="tblShowHandout" style="visibility:collapse;background-color:lightgreen;">
		<tr>
		<td id="tdHandout"></td>
		<td><a style="padding:2px;" id="openHandout" href="" target="_blank">到網頁</a></td>
		<td id="pnlHandout"></td>
		</tr>
	</table>


<div id="dvAudioLesson" style="position:relative;width:100%; border:1px solid black">
  <audio class="audioGroup" id="myAudio" style="margin:0;padding:1px;width:99%" controls>
  <source src="" type="audio/mpeg">
  </audio>


<!--Audio 面板操作區 width="99%" -->
<table class="audioGroup" style="padding-top:0;margin-top:-5px;">
<tr style="background-color:#EEFFFF;">
	<td>
		<button onclick="theAud.cusPlay();">播於</button>
	</td>

	<td><!--起播 時分秒-->
		<table id="tblPlayStart"><tr><td>
	<input id="palyStartH" type="number" value="0"  min="0" max="5" style="width:1em;"></input>時
	<input id="palyStartM" type="number" value="0" min="0" max="59" style="width:1.5em;"></input>分
	<input id="palyStartS" type="number" value="0" min="0" max="59" style="width:1.5em;"></input>秒
		</td></tr></table>
	</td><!--起播 時分秒-->

<td>
	<button onclick="theAud.cusTime(1);">設起點</button>
	<button onclick="theAud.forbackward(1);" style="color:DodgerBlue;font-weight:bold;">&lt;&lt;</button>

	<button onclick="theAud.forbackward(0);" style="color:DodgerBlue;font-weight:bold;">&gt;&gt;</button>
</td>


</tr></table><!--Audio 面板操作區-->


<!--cue、文檔操作區  width="99%" -->
<table><tr>

<!--文檔操作區-->
<td>
	<table style="padding:3px 5px;background-color:yellow;"><tr>

	<td>
			<button onclick="rstContHandFontSize('-')" style="padding-right:4px;color:DodgerBlue;">─</button>
			<span id="contFontSize" style="background-color:white;padding-left:3px;padding-right:3px;border:1px black solid;">96</span>
			<button style="color:DodgerBlue;" onclick="rstContHandFontSize('+')">✚</button>
	</td>

	<td>
		<button id="toggleAux" onclick="toggleAux(this)" class="toggle">課</button>
	</td>

	
<td style="position:relative;"><!--文檔工具區fixed-->
	<button onclick="tglDropDown(this, 1)" class="dropbtn">章</button>
	  <div id="dpdnChapterCm" class="dropdown-content"></div>
	  <div id="dpdnChapterAux" class="dropdown-content"></div>
	</td>
	<td style="position:relative;">
	<button onclick="tglDropDown(this,3)" class="dropbtn">目</button>
	  <div id="dpdnMenuCm" class="dropdown-content" style="width:14em;margin:0;padding:2px;left:-7em;">
<ul id="mnuRoot" class="menutree" onclick="onMenuClicked(event)" style="height:18em;overflow-y:scroll;margin-left:0;margin-top:0;padding-left:20px;padding-top:0"></ul></div>
	  <div id="dpdnMenuAux" class="dropdown-content" style="width:14em;margin:0;padding:2px;left:-7em;">
<ul id="mnuAux" class="menutree" onclick="onMenuClicked(event)" style="height:18em;overflow-y:scroll;margin-left:0;margin-top:0;padding-left:20px;padding-top:0"></ul></div>
	</td>

		
	<td>
		<select style="width:4em;font-size:95%;" id="pageList" onchange="theBook.onPageListChange(this)"></select>
	</td>

	<td>
		<select style="width:4em;font-size:95%;display:none" id="pageList_hand" onchange="theBook.onPageListChange(this)"></select>
	</td>
	

	<td>
	<button onclick="togglePageNum()" class="dropbtn">頁</button>
	</td>
	<td>
	<button onclick="toggleNA()" class="dropbtn" id="toggleNote">註</button>
	</td>
	<td>
	<button onclick="doToggleBR()" class="dropbtn" id="toggleLineNo">段</button>
	</td>

	<td>
			<button onclick="toggleTocBold()" class="dropbtn">B</button>
	</td>

	<td>
	<button onclick="toggleFullBookScreen()" class="dropbtn">全</button>
</td>
	</tr></table>
	
</td><!--文檔操作區-->

</tr></table><!--cue、文檔操作區-->

</div><!-- id="dvAudioLesson"-->



<!--文章顯示區-->

<div id="content" onscroll="TryScroll(event);" class="essay"></div>

<div id="auxPanel" onscroll="TryScroll(event);" class="essay" style="display:none;"></div>


<dialog id="dlgCue">
<button onclick="theAud.closeCue()" class="dlgCloser">✖</button>
<p class="dlgTitle">法師授課主題時點表</p>

<select id="cueList" style="width:16em;">
</select>

<div style="text-align:right;margin-top:2em;">
	<input type="checkbox" id="bookTo" checked>書本定位</input>　
	<button onclick="theAud.cuePointPlay()">播放</button>
</div>
</dialog>

<script>



</script>

</body>
</html>
